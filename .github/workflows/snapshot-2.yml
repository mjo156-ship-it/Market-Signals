# Signal Snapshot Generator v1.1
# Now includes BOIL/KOLD natural gas signals with weather integration
#
# Writes data/snapshot.json every 15 minutes during market hours
# To test: Actions ‚Üí Signal Snapshot ‚Üí Run workflow

name: Signal Snapshot

on:
  schedule:
    - cron: '30,45 14 * * 1-5'
    - cron: '0,15,30,45 15 * * 1-5'
    - cron: '0,15,30,45 16 * * 1-5'
    - cron: '0,15,30,45 17 * * 1-5'
    - cron: '0,15,30,45 18 * * 1-5'
    - cron: '0,15,30,45 19 * * 1-5'
    - cron: '0,15,30,45 20 * * 1-5'
    - cron: '0,15 21 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-snapshot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install yfinance pandas numpy requests

      - name: Generate snapshot
        run: |
          python3 << 'PYEOF'
          import json, sys, requests
          import yfinance as yf
          import pandas as pd
          import numpy as np
          from datetime import datetime, timezone, timedelta
          from pathlib import Path

          TICKERS = [
              'SPY','QQQ','SMH','IWM',
              'XLP','XLU','XLV','XLF','XLE',
              'GLD','TLT','HYG','LQD','TMV','USDU','BND',
              'UCO','BOIL','DBC',
              'UVXY','SVXY','VIXY','VIXM',
              'TQQQ','SOXL','SOXS','TECL','FAS','UPRO',
              'NAIL','CURE','LABU','DRN','FNGO','HIBL',
              'EDC','YINN','KORU','EURL','INDL',
              'BTC-USD',
              'AMD','NVDA',
              'VOOV','VOOG','VTV','QQQE',
              'KMLM','DBMF','CTA','BTAL',
              'KOLD',
          ]

          def calc_rsi(prices, period):
              delta = prices.diff()
              gain = delta.where(delta > 0, 0)
              loss = -delta.where(delta < 0, 0)
              avg_gain = gain.ewm(alpha=1/period, min_periods=period, adjust=False).mean()
              avg_loss = loss.ewm(alpha=1/period, min_periods=period, adjust=False).mean()
              rs = avg_gain / avg_loss
              return 100 - (100 / (1 + rs))

          def sf(value):
              if isinstance(value, pd.Series):
                  return float(value.iloc[-1]) if len(value) > 0 else None
              elif isinstance(value, np.ndarray):
                  return float(value[-1]) if len(value) > 0 else None
              elif pd.isna(value):
                  return None
              return float(value)

          # =================================================================
          # WEATHER FORECAST (Open-Meteo ‚Äî NYC)
          # =================================================================
          def get_weather_forecast():
              """Pull NYC 16-day forecast from Open-Meteo (free, no key)."""
              try:
                  url = ("https://api.open-meteo.com/v1/forecast"
                         "?latitude=40.74&longitude=-74.04"
                         "&daily=temperature_2m_max,temperature_2m_min"
                         "&temperature_unit=fahrenheit"
                         "&forecast_days=16"
                         "&timezone=America/New_York")
                  resp = requests.get(url, timeout=10)
                  data = resp.json()
                  daily = data.get('daily', {})
                  dates = daily.get('time', [])
                  highs = daily.get('temperature_2m_max', [])
                  lows = daily.get('temperature_2m_min', [])

                  if len(dates) < 7:
                      return None

                  today_avg = (highs[0] + lows[0]) / 2
                  day7_avg = (highs[6] + lows[6]) / 2
                  temp_change_7d = day7_avg - today_avg

                  # Find coldest day in next 7
                  avgs_7d = [(highs[i] + lows[i]) / 2 for i in range(min(7, len(dates)))]
                  coldest = min(avgs_7d)
                  coldest_day = dates[avgs_7d.index(coldest)]

                  # Check for severe cold (any day avg < 20¬∞F)
                  severe_cold = any(a < 20 for a in avgs_7d)

                  return {
                      'current_temp': round(today_avg, 1),
                      'temp_change_7d': round(temp_change_7d, 1),
                      'coldest_7d': round(coldest, 1),
                      'coldest_day': coldest_day,
                      'severe_cold': severe_cold,
                      'forecast_days': len(dates),
                      'daily_avgs': [round((highs[i]+lows[i])/2, 1) for i in range(min(16, len(dates)))],
                      'dates': dates[:16],
                  }
              except Exception as e:
                  print(f"  Weather API error: {e}")
                  return None

          # =================================================================
          # NATGAS SIGNAL EVALUATION
          # =================================================================
          def evaluate_natgas(indicators, raw_data, weather):
              """
              BOIL/KOLD signal based on backtested thresholds:
              - KOLD ENTRY: 5-day BOIL gain bands (primary trigger)
                Tier 1: 50%+ ‚Üí 100% win, +25.4% avg (n=7)
                Tier 1: 40%+ ‚Üí 89% win, +18.5% avg (n=9)
                Tier 2: 30%+ RSI>70 ‚Üí 92% win, +16.0% avg (n=12)
                Tier 2: 30%+ ‚Üí 88% win, +14.5% avg (n=24)
                Tier 3: 20%+ ‚Üí 66% win, +7.6% avg (n=76)
              - UCO Enhancement: UCO RSI>50 ‚Üí 77% KOLD win (vs 68% baseline)
              - Supply Shock: UVXY RSI>70 + UCO RSI>60 ‚Üí 73% win, +23.5% (n=11)
              - BOIL ENTRY: Cold forecast + RSI<50 + winter months
              - Weather Override: Blocks KOLD only when RSI<70 AND severe cold
              """
              boil = indicators.get('BOIL', {})
              kold = indicators.get('KOLD', {})
              uco = indicators.get('UCO', {})
              uvxy = indicators.get('UVXY', {})
              usdu = indicators.get('USDU', {})

              if not boil.get('price'):
                  return {'signal': 'NO_DATA', 'action': 'BOIL data unavailable'}

              boil_rsi = boil.get('rsi10', 50)
              boil_price = boil.get('price', 0)
              boil_5d = boil.get('ret_5d', 0) or 0
              boil_7d = None

              # Compute 7-day gain from raw data
              if 'BOIL' in raw_data and len(raw_data['BOIL']) > 8:
                  c = raw_data['BOIL']['Close']
                  boil_7d = round(sf((c.iloc[-1] / c.iloc[-8] - 1) * 100), 2)

              uco_rsi = uco.get('rsi10', 50)
              uvxy_rsi = uvxy.get('rsi10', 50)
              usdu_rsi = usdu.get('rsi10', 50)

              # Current month for winter check
              now_et = datetime.now(timezone.utc) + timedelta(hours=-5)
              is_winter = now_et.month in [11, 12, 1, 2, 3]

              # Weather data
              wx = weather or {}
              temp_change = wx.get('temp_change_7d', 0)
              current_temp = wx.get('current_temp')
              severe_cold = wx.get('severe_cold', False)

              # --- UCO Enhancement ---
              uco_enhanced = uco_rsi > 50 if uco_rsi else False
              uco_warning = uco_rsi < 50 if uco_rsi else False

              # --- Supply Shock ---
              supply_shock = (uvxy_rsi and uvxy_rsi > 70) and (uco_rsi and uco_rsi > 60)

              # --- KOLD Signal (Fade the spike) ---
              kold_signal = 'INACTIVE'
              kold_tier = None
              kold_reasoning = []

              if boil_5d >= 50:
                  kold_signal = 'ACTIVE'
                  kold_tier = 'TIER_1'
                  kold_reasoning.append(f'BOIL 5d gain {boil_5d:+.1f}% >= 50% ‚Üí 100% win, +25.4% avg (n=7)')
              elif boil_5d >= 40:
                  kold_signal = 'ACTIVE'
                  kold_tier = 'TIER_1'
                  kold_reasoning.append(f'BOIL 5d gain {boil_5d:+.1f}% >= 40% ‚Üí 89% win, +18.5% avg (n=9)')
              elif boil_5d >= 30 and boil_rsi > 70:
                  kold_signal = 'ACTIVE'
                  kold_tier = 'TIER_2'
                  kold_reasoning.append(f'BOIL 5d gain {boil_5d:+.1f}% >= 30% + RSI {boil_rsi:.1f} > 70 ‚Üí 92% win (n=12)')
              elif boil_5d >= 30:
                  kold_signal = 'ACTIVE'
                  kold_tier = 'TIER_2'
                  kold_reasoning.append(f'BOIL 5d gain {boil_5d:+.1f}% >= 30% ‚Üí 88% win, +14.5% avg (n=24)')
              elif boil_5d >= 20:
                  kold_signal = 'WATCH'
                  kold_tier = 'TIER_3'
                  kold_reasoning.append(f'BOIL 5d gain {boil_5d:+.1f}% >= 20% ‚Üí 66% win (n=76), partial position')

              # UCO enhancement / warning
              if kold_signal != 'INACTIVE':
                  if uco_enhanced:
                      kold_reasoning.append(f'UCO RSI {uco_rsi:.1f} > 50 ‚Üí Enhanced (77% win vs 68%)')
                  elif uco_warning:
                      kold_reasoning.append(f'‚ö†Ô∏è UCO RSI {uco_rsi:.1f} < 50 ‚Üí Caution (only 57% win)')

              # Supply shock overlay
              if supply_shock:
                  kold_reasoning.append(f'‚ö†Ô∏è Supply Shock: UVXY RSI {uvxy_rsi:.1f} > 70 + UCO RSI {uco_rsi:.1f} > 60 ‚Üí geopolitical risk')

              # Weather override (only blocks when RSI < 70 AND severe cold)
              weather_override = False
              if kold_signal == 'ACTIVE' and boil_rsi < 70 and severe_cold:
                  weather_override = True
                  kold_reasoning.append(f'‚ö†Ô∏è WEATHER OVERRIDE: RSI < 70 + severe cold forecast ‚Äî wait for warming')

              # --- BOIL Signal (Long entry) ---
              boil_signal = 'INACTIVE'
              boil_reasoning = []

              if is_winter and boil_rsi < 50 and temp_change < -10:
                  boil_signal = 'ACTIVE'
                  boil_reasoning.append(f'Winter + RSI {boil_rsi:.1f} < 50 + 7d temp drop {temp_change:+.1f}¬∞F ‚Üí BUY BOIL')
              elif is_winter and boil_rsi < 35 and temp_change < -5:
                  boil_signal = 'WATCH'
                  boil_reasoning.append(f'Winter + RSI {boil_rsi:.1f} < 35 + cooling {temp_change:+.1f}¬∞F ‚Üí Watch for BOIL entry')
              elif boil_rsi < 21:
                  boil_signal = 'WATCH'
                  boil_reasoning.append(f'BOIL RSI {boil_rsi:.1f} < 21 ‚Üí Extreme oversold (52% win historically)')

              # --- Composite signal ---
              if kold_signal == 'ACTIVE' and not weather_override:
                  signal = f'üî• KOLD {kold_tier}'
                  action = 'Enter KOLD (fade BOIL spike)'
              elif kold_signal == 'ACTIVE' and weather_override:
                  signal = '‚ö†Ô∏è KOLD PENDING (weather override)'
                  action = 'Wait for weather to turn warmer'
              elif kold_signal == 'WATCH':
                  signal = 'üü° KOLD WATCH'
                  action = 'Partial KOLD or wait for 30%+ spike'
              elif boil_signal == 'ACTIVE':
                  signal = 'üü¢ BOIL BUY'
                  action = 'Enter BOIL (cold forecast + oversold)'
              elif boil_signal == 'WATCH':
                  signal = 'üü° BOIL WATCH'
                  action = 'Monitor for BOIL entry'
              else:
                  signal = '‚ö™ NEUTRAL'
                  action = 'No clear natgas signal'

              return {
                  'signal': signal,
                  'action': action,
                  'boil': {
                      'price': boil_price,
                      'rsi10': boil_rsi,
                      'gain_5d': round(boil_5d, 1),
                      'gain_7d': round(boil_7d, 1) if boil_7d is not None else None,
                      'signal': boil_signal,
                      'reasoning': boil_reasoning,
                  },
                  'kold': {
                      'price': kold.get('price'),
                      'rsi10': kold.get('rsi10'),
                      'signal': kold_signal,
                      'tier': kold_tier,
                      'reasoning': kold_reasoning,
                      'weather_override': weather_override,
                  },
                  'macro_filters': {
                      'uco_rsi': uco_rsi,
                      'uco_enhanced': uco_enhanced,
                      'uvxy_rsi': uvxy_rsi,
                      'usdu_rsi': usdu_rsi,
                      'supply_shock': supply_shock,
                  },
                  'weather': {
                      'current_temp': current_temp,
                      'temp_change_7d': temp_change,
                      'severe_cold': severe_cold,
                      'is_winter': is_winter,
                  },
                  'thresholds': {
                      '30pct_5d': {'win_rate': '88%', 'avg_return': '+14.5%', 'n': 24},
                      '40pct_5d': {'win_rate': '89%', 'avg_return': '+18.5%', 'n': 9},
                      '50pct_5d': {'win_rate': '100%', 'avg_return': '+25.4%', 'n': 7},
                  },
              }

          # =================================================================
          # MAIN
          # =================================================================
          print(f"Downloading {len(TICKERS)} tickers...")
          raw = {}
          for t in TICKERS:
              try:
                  df = yf.download(t, period='2y', progress=False)
                  if len(df) > 0:
                      if isinstance(df.columns, pd.MultiIndex):
                          df.columns = df.columns.get_level_values(0)
                      raw[t] = df
              except Exception as e:
                  print(f"  {t}: {e}")
          print(f"Got {len(raw)} tickers")

          # Get weather
          print("Fetching weather forecast...")
          weather = get_weather_forecast()
          if weather:
              print(f"  NYC: {weather['current_temp']}¬∞F today, {weather['temp_change_7d']:+.1f}¬∞F 7d change")
          else:
              print("  Weather unavailable")

          indicators = {}
          for t, df in raw.items():
              if len(df) < 200:
                  # Allow shorter history for newer ETFs (KOLD, HIBL, etc.)
                  if len(df) < 50:
                      continue
                  # Compute what we can without SMA200
                  try:
                      c = df['Close']
                      p = sf(c.iloc[-1])
                      pp = sf(c.iloc[-2]) if len(c)>1 else p
                      r10 = sf(calc_rsi(c, 10).iloc[-1]) if len(c) > 11 else None
                      r1d = (p/pp-1)*100 if pp else None
                      r5d = sf((c.iloc[-1]/c.iloc[-6]-1)*100) if len(c)>6 else None
                      r10d = sf((c.iloc[-1]/c.iloc[-11]-1)*100) if len(c)>11 else None
                      r20d = sf((c.iloc[-1]/c.iloc[-21]-1)*100) if len(c)>21 else None
                      indicators[t] = {
                          'price': round(p,2) if p else None,
                          'change_pct': round(r1d,2) if r1d is not None else None,
                          'rsi10': round(r10,1) if r10 else None,
                          'ret_1d': round(r1d,2) if r1d is not None else None,
                          'ret_5d': round(r5d,2) if r5d is not None else None,
                          'ret_10d': round(r10d,2) if r10d is not None else None,
                          'ret_20d': round(r20d,2) if r20d is not None else None,
                      }
                  except:
                      pass
                  continue
              try:
                  c = df['Close']
                  p = sf(c.iloc[-1])
                  pp = sf(c.iloc[-2]) if len(c)>1 else p
                  r10 = sf(calc_rsi(c, 10).iloc[-1])
                  s50 = sf(c.rolling(50).mean().iloc[-1])
                  s200 = sf(c.rolling(200).mean().iloc[-1])
                  e9 = sf(c.ewm(span=9,adjust=False).mean().iloc[-1])
                  e20 = sf(c.ewm(span=20,adjust=False).mean().iloc[-1])
                  e50 = sf(c.ewm(span=50,adjust=False).mean().iloc[-1])
                  e200 = sf(c.ewm(span=200,adjust=False).mean().iloc[-1])
                  r1d = (p/pp-1)*100 if pp else None
                  r5d = sf((c.iloc[-1]/c.iloc[-6]-1)*100) if len(c)>6 else None
                  r10d = sf((c.iloc[-1]/c.iloc[-11]-1)*100) if len(c)>11 else None
                  r20d = sf((c.iloc[-1]/c.iloc[-21]-1)*100) if len(c)>21 else None
                  v200 = ((p/s200)-1)*100 if s200 and s200>0 else None
                  v50 = ((p/s50)-1)*100 if s50 and s50>0 else None
                  eb = e9>e20 if (e9 and e20) else None
                  indicators[t] = {
                      'price': round(p,2) if p else None,
                      'change_pct': round(r1d,2) if r1d is not None else None,
                      'rsi10': round(r10,1) if r10 else None,
                      'ema9': round(e9,2) if e9 else None,
                      'ema20': round(e20,2) if e20 else None,
                      'ema50': round(e50,2) if e50 else None,
                      'ema200': round(e200,2) if e200 else None,
                      'sma50': round(s50,2) if s50 else None,
                      'sma200': round(s200,2) if s200 else None,
                      'ema_cross': 'BULL' if eb else ('BEAR' if eb is not None else None),
                      'above_sma200': p>s200 if (p and s200) else None,
                      'vs_sma200': round(v200,1) if v200 is not None else None,
                      'vs_sma50': round(v50,1) if v50 is not None else None,
                      'ret_1d': round(r1d,2) if r1d is not None else None,
                      'ret_5d': round(r5d,2) if r5d is not None else None,
                      'ret_10d': round(r10d,2) if r10d is not None else None,
                      'ret_20d': round(r20d,2) if r20d is not None else None,
                  }
              except Exception as e:
                  print(f"  {t}: {e}")

          # --- Evaluate natgas ---
          natgas = evaluate_natgas(indicators, raw, weather)

          def rsi(t):
              return indicators.get(t,{}).get('rsi10')

          gld_r=rsi('GLD'); usdu_r=rsi('USDU'); xlp_r=rsi('XLP')
          spy_r=rsi('SPY'); qqq_r=rsi('QQQ'); smh_r=rsi('SMH')
          xlf_r=rsi('XLF'); uvxy_r=rsi('UVXY'); vixm_r=rsi('VIXM')

          playbook = {
              'GLD_RSI_gt_79':  {'value':gld_r,  'threshold':79, 'active': gld_r>79 if gld_r else False},
              'USDU_RSI_lt_25': {'value':usdu_r, 'threshold':25, 'active': usdu_r<25 if usdu_r else False},
              'XLP_RSI_gt_65':  {'value':xlp_r,  'threshold':65, 'active': xlp_r>65 if xlp_r else False},
              'XLP_RSI_gt_75':  {'value':xlp_r,  'threshold':75, 'active': xlp_r>75 if xlp_r else False},
              'SPY_RSI_gt_79':  {'value':spy_r,  'threshold':79, 'active': spy_r>79 if spy_r else False},
              'QQQ_RSI_gt_79':  {'value':qqq_r,  'threshold':79, 'active': qqq_r>79 if qqq_r else False},
              'SMH_RSI_gt_79':  {'value':smh_r,  'threshold':79, 'active': smh_r>79 if smh_r else False},
              'XLF_RSI_gt_70':  {'value':xlf_r,  'threshold':70, 'active': xlf_r>70 if xlf_r else False},
              'UVXY_RSI_gt_82': {'value':uvxy_r, 'threshold':82, 'active': uvxy_r>82 if uvxy_r else False},
              'VIXM_RSI_lt_25': {'value':vixm_r, 'threshold':25, 'active': vixm_r<25 if vixm_r else False},
          }

          ga = gld_r and gld_r>79
          ua = usdu_r and usdu_r<25
          x65 = xlp_r and xlp_r>65
          x75 = xlp_r and xlp_r>75

          combos = {
              'double_signal': {'active':bool(ga and ua), 'desc':'GLD>79+USDU<25 ‚Üí TQQQ'},
              'triple_signal': {'active':bool(ga and ua and x65), 'desc':'Double+XLP>65 ‚Üí TQQQ high conviction'},
              'xlp_cascade':   {'active':bool(x75), 'desc':'XLP>75 ‚Üí UVXY 1-day hold'},
          }

          tlt_r10 = indicators.get('TLT',{}).get('ret_10d')
          bnd_r10 = indicators.get('BND',{}).get('ret_10d')
          br = tlt_r10>0 if tlt_r10 is not None else None
          bond = {
              'direction': 'RISING' if br else ('FALLING' if br is False else 'UNKNOWN'),
              'tlt_ret_10d': round(tlt_r10,2) if tlt_r10 is not None else None,
              'bnd_ret_10d': round(bnd_r10,2) if bnd_r10 is not None else None,
              'uvxy_conviction': 'MODERATE' if br else ('HIGH' if br is False else None),
          }

          si = indicators.get('SMH',{})
          s2 = si.get('sma200')
          smh_lev = {
              'price': si.get('price'), 'sma200': s2,
              'pct_above': si.get('vs_sma200'),
              'trim': round(s2*1.30,2) if s2 else None,
              'warn': round(s2*1.35,2) if s2 else None,
              'sell': round(s2*1.40,2) if s2 else None,
          }

          contrarian = {}
          for t in ['FAS','TECL','FNGO','LABU','NAIL']:
              ind = indicators.get(t,{})
              r = ind.get('rsi10')
              b200 = ind.get('above_sma200') is False
              be = ind.get('ema_cross')=='BEAR'
              st = 'ACTIVE' if (r and b200 and r<40) else ('WATCH' if (r and b200 and r<50) else 'INACTIVE')
              contrarian[t] = {'rsi10':r, 'below_sma200':b200, 'bear_ema':be, 'status':st}

          extended = {}
          for t in ['SOXL','KORU','EDC','HIBL','LABU','SMH']:
              ind = indicators.get(t,{})
              v = ind.get('vs_sma200')
              if v is not None and v>50:
                  extended[t] = {'vs_sma200':v, 'rsi10':ind.get('rsi10'), 'warning':'EXTENDED' if v>100 else 'ELEVATED'}

          alerts = []
          if combos['double_signal']['active']:
              alerts.append('DOUBLE SIGNAL: GLD/USDU ‚Üí TQQQ buy')
          if combos['triple_signal']['active']:
              alerts.append('TRIPLE SIGNAL: GLD/USDU/XLP ‚Üí TQQQ high conviction')
          if combos['xlp_cascade']['active']:
              alerts.append('XLP CASCADE: RSI>75 ‚Üí UVXY 1-day hold')

          # Natgas alerts
          if natgas.get('kold', {}).get('signal') == 'ACTIVE':
              tier = natgas['kold']['tier']
              gain = natgas['boil']['gain_5d']
              alerts.append(f'KOLD {tier}: BOIL 5d gain {gain:+.1f}% ‚Üí fade spike')
          elif natgas.get('kold', {}).get('signal') == 'WATCH':
              alerts.append(f'KOLD WATCH: BOIL 5d gain {natgas["boil"]["gain_5d"]:+.1f}%')
          if natgas.get('boil', {}).get('signal') == 'ACTIVE':
              alerts.append(f'BOIL BUY: cold forecast + oversold')
          elif natgas.get('boil', {}).get('signal') == 'WATCH':
              alerts.append(f'BOIL WATCH: approaching entry')

          for t,cv in contrarian.items():
              if cv['status']=='ACTIVE': alerts.append(f'{t} CONTRARIAN: RSI<40+below SMA200')
              elif cv['status']=='WATCH': alerts.append(f'{t} WATCH: below SMA200, nearing oversold')
          for t,e in extended.items():
              alerts.append(f'{t} {e["warning"]}: {e["vs_sma200"]:+.0f}% above SMA200')

          now_utc = datetime.now(timezone.utc)
          now_et = now_utc + timedelta(hours=-5)

          snapshot = {
              'meta': {
                  'generated_utc': now_utc.isoformat(),
                  'generated_et': now_et.strftime('%Y-%m-%d %H:%M:%S ET'),
                  'ticker_count': len(indicators),
                  'version': '1.1',
              },
              'signals': {
                  'playbook': playbook,
                  'combos': combos,
                  'bond_momentum': bond,
                  'smh_levels': smh_lev,
                  'contrarian': contrarian,
                  'extended': extended,
                  'natgas': natgas,
                  'active_alerts': alerts,
              },
              'indicators': indicators,
          }

          Path('data').mkdir(exist_ok=True)
          with open('data/snapshot.json','w') as f:
              json.dump(snapshot, f, indent=2, default=str)

          print(f"\nSnapshot written: {len(indicators)} tickers")
          print(f"Alerts: {len(alerts)}")
          for a in alerts:
              print(f"  {a}")

          # Natgas summary
          print(f"\nNATGAS: {natgas['signal']}")
          print(f"  BOIL: ${natgas['boil']['price']} RSI={natgas['boil']['rsi10']:.1f} 5d={natgas['boil']['gain_5d']:+.1f}%")
          if natgas['kold'].get('price'):
              print(f"  KOLD: ${natgas['kold']['price']} RSI={natgas['kold']['rsi10']}")
          for r in natgas['kold'].get('reasoning', []) + natgas['boil'].get('reasoning', []):
              print(f"    {r}")
          if weather:
              print(f"  Weather: {weather['current_temp']}¬∞F, 7d change: {weather['temp_change_7d']:+.1f}¬∞F")
          PYEOF

      - name: Commit snapshot
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/snapshot.json
          if git diff --staged --quiet; then
            echo "No changes"
          else
            TIMESTAMP=$(date -u +"%H:%M UTC")
            git commit -m "üì° Signal snapshot ${TIMESTAMP}"
            git pull --rebase
            git push
            echo "Snapshot pushed"
          fi
